# 実装概要（初期スケルトン v1）

本ドキュメントは 02100_設計書.md の構成に従い作成した初期スケルトン実装の対応状況を示します。

## 1. VS Code 拡張（LM Tools）
- ルート: `databricks-knowledge-search/`
- ツールID: `databricks-knowledge-search_search`（`toolReferenceName: dbxSearch`）
- 入力スキーマ:
  - `mode`: `sql | query | vector | serving | genie`（必須）
  - `query`: 文字列（任意）
  - `resourceId`: 文字列（任意・モードにより必須）
  - `topK`: 数値（任意、vector 用）
  - `format`: `markdown | json`（任意、既定 `markdown`）
- 主なファイル:
  - `src/extension.ts` — ツール登録
  - `src/tools/dbxSearchTool.ts` — LM Tool 実装（確認ダイアログ、結果整形、エラーハンドリング）
  - `src/services/gatewayClient.ts` — Gateway API クライアント（タイムアウト、エラー処理）
  - `src/services/authService.ts` — 設定から Bearer トークン取得
  - `src/utils/logger.ts` — 出力チャネルロガー
  - `src/config/resources.json` — 参考リソース定義（サンプル）
- 設定:
  - `databricks-knowledge-search.gatewayUrl`（必須）
  - `databricks-knowledge-search.timeout`（既定: 10000ms）
  - `databricks-knowledge-search.authToken`（任意）

## 2. Gateway API（スタブ）
- ルート: `gateway-api/`
- フレームワーク: FastAPI
- エンドポイント（設計書/調査ドキュメントに対応）:
  - Databricks SQL
    - Statement Execution: `POST /sql/statements`, `GET /sql/statements/{id}`, `POST /sql/statements/{id}/cancel`, `GET /sql/statements/{id}/result/chunks/{chunk}`
    - External Links: `POST /sql/statements/external-links/fetch`
    - Queries: `GET /sql/queries`, `GET /sql/queries/{id}`
  - Vector Search
    - Endpoints: `GET /vector-search/endpoints`, `GET /vector-search/endpoints/{name}`
    - Indexes: `GET /vector-search/indexes`, `GET /vector-search/indexes/{name}`, `POST /vector-search/indexes/query`, `POST /vector-search/indexes/query/next-page`, `POST /vector-search/indexes/scan`
  - Real-Time Serving
    - `GET /serving-endpoints`, `GET /serving-endpoints/{name}`, `GET /serving-endpoints/{name}/openapi`, `POST /serving-endpoints/{name}/invocations`
  - Genie
    - `GET /genie/spaces`, `GET /genie/spaces/{spaceId}`, `GET /genie/spaces/{spaceId}/conversations`,
      `POST /genie/spaces/{spaceId}/conversations/{conversationId}/messages`,
      `GET /genie/spaces/{spaceId}/conversations/{conversationId}/messages/{messageId}`,
      `POST /genie/spaces/{spaceId}/conversations/{conversationId}/messages/{messageId}/attachments/{attachmentId}/execute-query`,
      `GET /genie/spaces/{spaceId}/conversations/{conversationId}/messages/{messageId}/attachments/{attachmentId}/query-result`,
      `POST /genie/spaces/{spaceId}/start-conversation`
- DI 切替（環境変数 `DI_PROVIDER`）:
  - `env`: `.env` の `DATABRICKS_PAT` を使用（`EnvTokenProvider`）
  - `keyvault`: `KEYVAULT_URL`/`SECRET_NAME` から PAT を取得（`KeyVaultTokenProvider`）
- Docker Compose: ルート `docker-compose.yaml` にて環境変数で切替
- 今後の実装:
  - 認証（JWT 検証、Managed ID → Databricks Token）
  - リバースプロキシ（httpx 経由で Databricks API 転送）
  - レート制限、監査ログ、PII マスキング

## 3. 既知の未対応（ToDo）
- `resources.json` の ID バリデーション＆補完ロジック
- SQL Statement API のハイブリッドモード（wait_timeout / on_wait_timeout）
- 25MiB 超の結果に対する EXTERNAL_LINKS 取得フロー
- VSIX 署名や企業ポリシー連携の手順化

## 4. 動作確認（開発環境）
1. `.env` 作成: `cp gateway-api/.env.example gateway-api/.env`（`DI_PROVIDER=env` のまま PAT を設定）
2. Gateway を起動: `docker compose up --build`
2. VS Code で拡張を起動（F5）。
3. Copilot Chat でツール呼び出し:
   ```
   @tools:dbxSearch { "mode": "vector", "query": "lakehouse", "resourceId": "kb_documents_default", "topK": 3 }
   ```
