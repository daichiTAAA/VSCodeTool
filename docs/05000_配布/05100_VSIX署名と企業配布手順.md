# VSIX 署名と企業ポリシー配布手順

本書は Databricks Knowledge Search 拡張の VSIX 署名と、企業内配布（ポリシー配布）手順をまとめたものです。

## 1. VSIX パッケージ作成
- `vsce`のインストール方法: [VSCode公式ページ Publishing Extensions](https://code.visualstudio.com/api/working-with-extensions/publishing-extension)
  ```bash
  npm install -g @vscode/vsce
  ```
- 前提: Node.js / npm, `vsce` インストール済み
```
cd databricks-knowledge-search
npm install
npm run compile
vsce package -o databricks-knowledge-search-0.1.0.vsix
```

## 2. VSIX 署名
企業署名証明書（PFX）を用いて VSIX を署名します。環境に応じて方法を選択してください。

### 2.1 Windows: VSIXSignTool
- 前提: Visual Studio 拡張開発ツールセットに含まれる `VSIXSignTool.exe`
```
VSIXSignTool sign /f C:\certs\company-code-signing.pfx /p <PFX_PASSWORD> databricks-knowledge-search-1.0.0.vsix
```

### 2.2 クロスプラットフォーム（CI 推奨）: セキュア署名サービス
- Code Signing Service（社内 CA / HSM）にアップロードし、同等の VSIX 署名を実施
- 署名後の VSIX を配布レポジトリに登録

注: 一部の `vsce` には `--sign` オプションが存在しますが、運用の確実性の観点から公式の VSIX 署名ツール／社内署名サービスの使用を推奨します。

## 3. 企業内配布（2 方式）

### 3.1 内部マーケットプレース（推奨）
- 企業の拡張ギャラリー（オンプレ／社内クラウド）へ署名済み VSIX を公開
- ユーザーは通常の拡張検索・インストールフローで導入可能

### 3.2 直接配布（VSIX 配布）
- 署名済み VSIX を社内ストレージに配置し、開発者に配布
- 導入: VS Code → Extensions → 「...」→ Install from VSIX

## 4. ポリシー配布（VS Code 設定）
組織ポリシーで拡張の利用を制御します。構成管理（例: Intune / GPO / Jamf）で配布してください。

### 4.1 推奨ポリシー
```
{
  "extensions.allowed": ["company.databricks-knowledge-search"],
  "chat.agent.enabled": true,
  "chat.extensionTools.enabled": true,
  "security.workspace.trust.enabled": true
}
```

### 4.2 代理設定（Gateway URL 等）
```
{
  "databricks-knowledge-search.gatewayUrl": "https://api.company.com/knowledge",
  "databricks-knowledge-search.timeout": 10000
}
```

## 5. リリースフロー（例）
1. 変更のビルド・テスト（CI）
2. `vsce package` で VSIX 作成
3. 署名（VSIXSignTool or 社内署名サービス）
4. 内部マーケットプレースへ発行／VSIX 配布
5. ポリシー更新（新バージョン許可・必須化）
6. ロールアウト監視（利用状況・失敗率）

## 6. 検証チェックリスト
- VSIX が署名済みである（署名検証で OK）
- 企業ポリシーで拡張が許可されている
- Copilot Chat で `dbxSearch` ツールが利用可能
- Gateway の監査ログにトラフィックが記録される

