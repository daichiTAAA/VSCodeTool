# VS Code Language Model Tool API を活用した Azure Databricks ナレッジベース連携システム 要件定義書

<br>

# 文書情報
---
* **文書名**: VS Code LM Tools × Azure Databricks ナレッジベース連携システム 要件定義書
* **作成日**: 2025年9月1日
* **更新日**: 2025年9月1日
* **バージョン**: 1.0
* **作成者**: システム開発チーム

<br>

# 1. プロジェクト概要
---

## 1.1 背景
現在、社内ナレッジベースとして Azure Databricks を活用しているが、開発者が GitHub Copilot を使用する際に、このナレッジベースの情報を効率的に参照できていない状況にある。開発者は別途ブラウザで Databricks にアクセスして情報を検索する必要があり、開発効率の低下を招いている。

## 1.2 目的
VS Code の Language Model Tool API を活用して、GitHub Copilot の Agent モードから直接 Azure Databricks のナレッジベースを検索・参照可能にし、開発効率の向上とナレッジの有効活用を実現する。

## 1.3 プロジェクトスコープ

### 対象範囲
- VS Code 内での GitHub Copilot Agent モードからの Databricks ナレッジベース検索
- 検索専用アクセス（読み取りのみ）
- セキュアな認証・認可機構
- 企業ガバナンス対応

### 対象外
- データの生成・更新機能
- VS Code 以外のエディタ対応
- Databricks ナレッジベースの構築・管理

<br>

# 2. システム要件
---

## 2.1 機能要件

### 2.1.1 ナレッジベース検索機能
- **FR-001**: GitHub Copilot Agent モードから Azure Databricks のナレッジベースを検索できること
- **FR-002**: 検索結果にタイトル、概要、ソースURL、関連テキストが含まれること
- **FR-003**: 検索結果を基に Copilot が引用元を明記した回答を生成できること
- **FR-004**: 明示的なツール呼び出し（`#dbxSearch`）に対応すること
- **FR-005**: Agent モードでの自動ツール選択に対応すること

### 2.1.2 セキュリティ機能
- **FR-006**: 検索専用アクセス（データの変更・削除は不可）であること
- **FR-007**: OAuth2 認証による安全なアクセス制御を実装すること
- **FR-008**: アクセスログの記録・監査機能を提供すること
- **FR-009**: ツール実行時に確認ダイアログを表示すること
- **FR-010**: 企業ポリシーによる利用制御に対応すること

### 2.1.3 運用管理機能
- **FR-011**: 組織管理者による拡張の許可リスト管理に対応すること
- **FR-012**: レート制御機能を提供すること
- **FR-013**: キャッシュ機能による同一クエリの効率化を実装すること
- **FR-014**: PII・秘匿情報のマスキング機能を提供すること

## 2.2 非機能要件

### 2.2.1 性能要件
- **NFR-001**: 検索レスポンス時間は5秒以内であること
- **NFR-002**: 同時接続ユーザー数は100名まで対応すること
- **NFR-003**: システム可用性は99.5%以上であること

### 2.2.2 セキュリティ要件
- **NFR-004**: 通信はすべてHTTPS（TLS 1.2以上）で暗号化すること
- **NFR-005**: アクセスログは最低1年間保持すること
- **NFR-006**: 個人情報を含むログはハッシュ化して保存すること
- **NFR-007**: WAF・IP制限による境界防御を実装すること

### 2.2.3 運用要件
- **NFR-008**: 管理者による設定変更は即座に反映されること
- **NFR-009**: システム監視・アラート機能を提供すること
- **NFR-010**: 障害時の自動復旧機能を実装すること

<br>

# 3. システム構成
---

## 3.1 アーキテクチャ概要

```
[VS Code + GitHub Copilot Agent Mode]
            ↓ LM Tools API
[VS Code 拡張（LM Tools実装）]
            ↓ HTTPS + OAuth2
[Gateway API（検索専用）]
            ↓ Statement Execution API 2.0
[Azure Databricks SQL Warehouse]
            ↓ Unity Catalog
[ナレッジベース（検索ビュー）]
```

## 3.2 コンポーネント仕様

### 3.2.1 VS Code 拡張（LM Tools）
- **役割**: GitHub Copilot と Gateway API の橋渡し
- **技術**: TypeScript, VS Code Extension API, Language Model Tool API
- **主要機能**:
  - `dbxSearch` ツールの登録・実装
  - Gateway API への認証済みリクエスト送信
  - 検索結果の整形・返却

### 3.2.2 Gateway API
- **役割**: セキュアな検索API の提供
- **技術**: Node.js/Python, Express/FastAPI, OAuth2
- **主要機能**:
  - 認証・認可処理
  - Databricks Statement Execution API の呼び出し
  - レート制御・監査ログ
  - PII マスキング・キャッシュ

### 3.2.3 Azure Databricks
- **役割**: ナレッジベースの提供
- **技術**: Azure Databricks, Unity Catalog, SQL Warehouse
- **主要機能**:
  - ナレッジデータの格納・管理
  - 検索ビューの提供
  - アクセス制御（Unity Catalog）

<br>

# 4. 詳細仕様
---

## 4.1 API仕様

### 4.1.1 Gateway API エンドポイント

#### GET /search
**概要**: ナレッジベース検索

**パラメータ**:
- `q` (string, required): 検索クエリ
- `top_k` (integer, optional): 取得件数上限（デフォルト: 5, 最大: 20）

**レスポンス**:
```json
{
  "results": [
    {
      "title": "記事タイトル",
      "snippet": "関連テキスト抜粋",
      "source_url": "元文書URL",
      "id": "一意識別子",
      "relevance_score": 0.95
    }
  ],
  "query_id": "検索ID（監査用）",
  "execution_time_ms": 1250
}
```

### 4.1.2 Databricks 検索ビュー

#### main.knowledge.kb_docs
**カラム構成**:
- `id` (string): 一意識別子
- `title` (string): 文書タイトル
- `snippet` (string): 概要・抜粋
- `source_url` (string): 元文書URL
- `text` (string): 全文テキスト
- `category` (string): カテゴリ分類
- `updated_at` (timestamp): 更新日時

## 4.2 セキュリティ仕様

### 4.2.1 認証・認可
- **認証方式**: OAuth2 Client Credentials Flow
- **トークン有効期限**: 1時間
- **権限設定**:
  - SQL Warehouse: CAN USE
  - 検索ビュー: SELECT のみ

### 4.2.2 監査ログ
**記録項目**:
- ユーザー識別子（ハッシュ化）
- 実行時刻
- 検索クエリ（ハッシュ化）
- 結果件数
- レスポンス時間
- IPアドレス

<br>

# 5. 運用要件
---

## 5.1 企業ガバナンス

### 5.1.1 VS Code ポリシー設定
```json
{
  "chat.agent.enabled": true,
  "chat.extensionTools.enabled": true,
  "extensions.allowed": [
    "company.databricks-knowledge-search"
  ]
}
```

### 5.1.2 アクセス制御
- **対象者**: 開発チームメンバー（約50名）
- **承認プロセス**: 部門管理者による事前承認
- **権限レビュー**: 四半期毎

## 5.2 監視・運用

### 5.2.1 監視項目
- API レスポンス時間
- エラー率
- 同時接続数
- Databricks SQL Warehouse の負荷

### 5.2.2 アラート設定
- レスポンス時間 > 10秒
- エラー率 > 5%
- 同時接続数 > 80

<br>

# 6. 開発・導入計画
---

## 6.1 開発フェーズ

### Phase 1: 基盤構築（4週間）
- **Week 1-2**: Gateway API 開発
  - 基本的な検索API実装
  - OAuth2 認証機構
  - Databricks連携
- **Week 3-4**: VS Code 拡張開発
  - LM Tools 基本実装
  - Gateway API 連携
  - 基本テスト

### Phase 2: セキュリティ強化（3週間）
- **Week 5-6**: セキュリティ機能実装
  - 監査ログ機能
  - PII マスキング
  - レート制御
- **Week 7**: セキュリティテスト・脆弱性検査

### Phase 3: 運用準備（2週間）
- **Week 8**: 運用機能実装
  - 監視・アラート
  - 管理画面
- **Week 9**: 運用テスト・ドキュメント整備

### Phase 4: パイロット・本格導入（3週間）
- **Week 10**: パイロットユーザーでのテスト
- **Week 11**: フィードバック対応・改善
- **Week 12**: 本格導入・全体展開

## 6.2 成果物

### 開発成果物
- VS Code 拡張（VSIX パッケージ）
- Gateway API サーバー
- Databricks 検索ビュー
- 設定・運用ドキュメント

### ドキュメント
- システム設計書
- API 仕様書
- 運用手順書
- セキュリティガイドライン
- ユーザーマニュアル

<br>

# 7. リスク管理
---

## 7.1 技術リスク

| リスク項目                         | 影響度 | 発生確率 | 対策                                              |
| ---------------------------------- | ------ | -------- | ------------------------------------------------- |
| Language Model Tool API の仕様変更 | 高     | 中       | VS Code更新情報の定期確認、バージョン互換性テスト |
| Databricks API の制限・変更        | 中     | 低       | 代替API検討、Statement Execution API の継続監視   |
| パフォーマンス問題                 | 中     | 中       | キャッシュ実装、クエリ最適化                      |

## 7.2 セキュリティリスク

| リスク項目       | 影響度 | 発生確率 | 対策                               |
| ---------------- | ------ | -------- | ---------------------------------- |
| 不正アクセス     | 高     | 低       | OAuth2認証、IP制限、WAF導入        |
| データ漏洩       | 高     | 低       | 最小権限、PII マスキング、監査ログ |
| 社内ポリシー違反 | 中     | 中       | 事前承認プロセス、定期レビュー     |

## 7.3 運用リスク

| リスク項目       | 影響度 | 発生確率 | 対策                             |
| ---------------- | ------ | -------- | -------------------------------- |
| 利用者教育不足   | 中     | 中       | ユーザーマニュアル整備、研修実施 |
| 運用コスト増大   | 中     | 中       | 自動化推進、監視ツール活用       |
| 依存システム障害 | 高     | 低       | 冗長化、フェイルオーバー機構     |

<br>

# 8. 前提条件・制約事項
---

## 8.1 前提条件
- VS Code 1.99 以上がインストールされていること
- GitHub Copilot Business/Enterprise ライセンスを保有していること
- Azure Databricks へのアクセス権限を保有していること
- 社内ネットワークからのアクセスであること

## 8.2 制約事項
- 検索機能のみ提供（データの作成・更新・削除は不可）
- VS Code 環境のみ対応
- 日本語・英語のナレッジベースのみ対応
- 同時検索数は組織あたり100件まで

<br>

# 9. 成功基準
---

## 9.1 定量的指標
- **検索レスポンス時間**: 平均3秒以内
- **システム可用性**: 99.5%以上
- **ユーザー採用率**: 対象チーム内で80%以上
- **検索成功率**: 95%以上

## 9.2 定性的指標
- 開発者の作業効率向上を実感
- ナレッジベースの活用頻度増加
- セキュリティインシデント発生なし
- 運用負荷の許容範囲内での維持

<br>

# 10. 今後の展開
---

## 10.1 短期拡張（6ヶ月以内）
- 検索精度の向上（ベクトル検索導入）
- 検索結果のカテゴリフィルタ機能
- 使用統計・分析機能

## 10.2 中期拡張（1年以内）
- GitHub Copilot Extensions 対応（Ask モード）
- 他のナレッジソース連携（SharePoint、Confluence）
- 多言語対応拡張

## 10.3 長期展望（1年超）
- MCP（Model Context Protocol）対応
- 他の IDE・エディタ対応
- AI による自動ナレッジ分類・整理機能

<br>

# 11. 承認
---

| 役職                     | 氏名 | 承認日 | 署名 |
| ------------------------ | ---- | ------ | ---- |
| プロジェクトマネージャー |      |        |      |
| 技術責任者               |      |        |      |
| セキュリティ責任者       |      |        |      |
| 情報システム部長         |      |        |      |

---

**注記**: 本要件定義書は、添付された「LanguageModelToolAPIの使用検討」資料を基に作成されており、技術的詳細については該当資料を参照してください。